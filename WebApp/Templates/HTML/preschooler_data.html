<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Preschooler Details</title>
  <link rel="stylesheet" href="{% static 'css/preschooler_data.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="{% static 'javascript/preschooler_data.js' %}" defer></script>
  <style>
    .photo-placeholder {
      width: 180px;
      height: 180px;
      background-color: #f0f0f0;
      border: 2px dashed #ccc;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .photo-placeholder img.child-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }
    /* Status badge styles */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      display: inline-block;
    }
    .status-scheduled { background: #e3f2fd; color: #1565c0; }
    .status-completed { background: #e8f5e8; color: #2e7d32; }
    .status-rescheduled { background: #fff3e0; color: #f57c00; }
    .status-missed { background: #ffebee; color: #d32f2f; }
    
    /* Action buttons - CENTERED */
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }
    
    /* Make Actions column center-aligned */
    .info-table th:last-child,
    .info-table td:last-child {
      text-align: center;
    }
    
    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .btn-complete { background: #4caf50; color: white; }
    .btn-reschedule { background: #ff9800; color: white; }
    .btn-complete:hover { background: #45a049; }
    .btn-reschedule:hover { background: #e68900; }
    .text-success { color: #2e7d32; font-weight: 500; }
    
    /* Modal styles for reschedule */
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    /* Schedule modal specific styles */
    .schedule-modal-card {
      max-width: 500px;
      width: 90%;
    }
    
    .schedule-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    /* Section header with button */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    /* Vaccine Card Modal Specific Styles */
    #vaccineCardModal .modal-card {
      max-width: 95%;
      width: 1200px;
      background: linear-gradient(135deg, #2c5530 0%, #1a3d1f 100%);
      color: white;
      border-radius: 15px;
    }
    
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      z-index: 1001;
    }
    
    .close-modal:hover {
      color: #000;
    }
    
    .schedule-close-modal {
      color: #333;
    }
    
    .schedule-close-modal:hover {
      color: #666;
    }
    
    /* Modal info grid */
    .modal-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
      background: white;
      padding: 25px;
      border-radius: 10px;
      color: #333;
    }
    
    .modal-info-grid > div {
      display: flex;
      flex-direction: column;
    }
    
    .modal-info-grid label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .modal-info-grid input {
      padding: 10px;
      border: none;
      border-bottom: 2px solid #ddd;
      background: transparent;
      font-size: 14px;
      color: #333;
    }
    
    .modal-info-grid input:focus {
      outline: none;
      border-bottom-color: #2c5530;
    }
    
    /* Vaccine table in modal */
    .vaccine-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    .vaccine-table th {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      padding: 15px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }
    .vaccine-table td {
      border: 1px solid #ddd;
      padding: 12px 8px;
      text-align: center;
      background: white;
      color: #333;
    }
    .vaccine-table tr:nth-child(even) td {
      background: #f9f9f9;
    }
    .vaccine-table input {
      border: none;
      background: transparent;
      width: 100%;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      color: #333;
    }
    .vaccine-table input:focus {
      outline: 2px solid #2c5530;
      border-radius: 3px;
    }
    .vaccine-table .vaccine-name {
      text-align: left;
      font-weight: 500;
    }
    .dose-badge {
      background: #e67e22;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }
    .modal-note {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid #f39c12;
      font-size: 13px;
      color: white;
      border-radius: 5px;
    }
    
    /* Button styles */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-block;
      transition: background-color 0.3s;
    }
    
    .btn-green {
      background-color: #4caf50;
      color: white;
    }
    
    .btn-green:hover {
      background-color: #45a049;
    }
    
    .btn-gray {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-gray:hover {
      background-color: #545b62;
    }
    
    .btn-blue {
      background-color: #007bff;
      color: white;
    }
    
    .btn-blue:hover {
      background-color: #0056b3;
    }

    .btn-orange {
      background-color: #ff9800;
      color: white;
    }
    
    .btn-orange:hover {
      background-color: #e68900;
    }
    
    .add-schedule-btn {
      background-color: #28a745;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
    }
    
    .add-schedule-btn:hover {
      background-color: #218838;
    }

    /* Nutrition Services specific styles */
    .add-nutrition-btn {
      background-color: #28a745;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
    }
    
    .add-nutrition-btn:hover {
      background-color: #218838;
    }

    /* PDF content styles - hidden by default */
    .pdf-content {
      display: none;
      background: white;
      padding: 40px;
      font-family: Arial, sans-serif;
      color: #333;
      line-height: 1.6;
    }

    .pdf-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #2c5530;
      padding-bottom: 20px;
    }

    .pdf-title {
      font-size: 24px;
      font-weight: bold;
      color: #2c5530;
      margin-bottom: 10px;
    }

    .pdf-subtitle {
      font-size: 16px;
      color: #666;
    }

    .pdf-child-info {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #2c5530;
    }

    .pdf-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .pdf-info-item {
      display: flex;
      align-items: center;
    }

    .pdf-info-label {
      font-weight: bold;
      color: #2c5530;
      min-width: 120px;
    }

    .pdf-vaccine-section {
      margin-bottom: 30px;
    }

    .pdf-section-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c5530;
      margin-bottom: 15px;
      border-bottom: 2px solid #f39c12;
      padding-bottom: 5px;
    }

    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 2px solid #2c5530;
    }

    .pdf-table th {
      background: #2c5530;
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: bold;
      border: 1px solid #2c5530;
    }

    .pdf-table td {
      border: 1px solid #ddd;
      padding: 10px 8px;
      text-align: center;
      background: white;
    }

    .pdf-table tr:nth-child(even) td {
      background: #f9f9f9;
    }

    .pdf-vaccine-name {
      text-align: left !important;
      font-weight: 500;
    }

    .pdf-dose-badge {
      background: #f39c12;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }

    .pdf-status-completed {
      color: #2e7d32;
      font-weight: bold;
    }

    .pdf-status-scheduled {
      color: #1565c0;
      font-weight: bold;
    }

    .pdf-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #ddd;
      text-align: center;
      color: #666;
      font-size: 12px;
    }

    .modal-action-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    /* Responsive design */
    @media (max-width: 1200px) {
      .modal-info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .pdf-info-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .modal-info-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-card {
        width: 95%;
        padding: 15px;
      }
      
      .vaccine-table {
        font-size: 12px;
      }
      
      .vaccine-table th,
      .vaccine-table td {
        padding: 8px 4px;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .pdf-info-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('#vaccineCardModal form');
      if (!form) return;
      const toggleButton = document.createElement('button');
      toggleButton.textContent = 'Edit';
      toggleButton.type = 'button';
      toggleButton.className = 'btn btn-blue';
      const saveBtn = form.querySelector('button[type="submit"]');
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.type = 'button';
      cancelBtn.className = 'btn btn-gray';

      let editing = false;

      // Function to disable editable inputs
      function disableInputs() {
        // Disable child info inputs (not readonly ones)
        form.querySelectorAll('.modal-info-grid input[name]').forEach(input => {
          if (input.type !== 'radio') {
            input.setAttribute('readonly', true);
          } else {
            input.setAttribute('disabled', true);
          }
        });
        
        // Disable ALL inputs in the vaccine table (including remarks)
        form.querySelectorAll('.vaccine-table input').forEach(input => {
          input.setAttribute('readonly', true);
        });
      }

      // Function to enable editable inputs
      function enableInputs() {
        // Enable child info inputs (not readonly ones)
        form.querySelectorAll('.modal-info-grid input[name]').forEach(input => {
          if (input.type !== 'radio') {
            input.removeAttribute('readonly');
          } else {
            input.removeAttribute('disabled');
          }
        });
        
        // Enable ALL inputs in the vaccine table (including remarks)
        form.querySelectorAll('.vaccine-table input').forEach(input => {
          input.removeAttribute('readonly');
        });
      }

      // Disable inputs on load
      disableInputs();

      toggleButton.addEventListener('click', () => {
        editing = true;
        enableInputs();
        toggleButton.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
      });

      cancelBtn.addEventListener('click', () => {
        location.reload();
      });

      const btnContainer = saveBtn.parentElement;
      btnContainer.insertBefore(toggleButton, saveBtn);
      btnContainer.appendChild(cancelBtn);
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
    });
    
    // Modal functions
    function openVaccineCardModal() {
      document.getElementById('vaccineCardModal').style.display = 'flex';
    }
    
    function closeVaccineCardModal() {
      document.getElementById('vaccineCardModal').style.display = 'none';
    }
    
    function openAddScheduleModal() {
      document.getElementById('addScheduleModal').style.display = 'flex';
    }
    
    function closeAddScheduleModal() {
      document.getElementById('addScheduleModal').style.display = 'none';
    }
    
    function openAddVaccineModal() {
      document.getElementById('addVaccineModal').style.display = 'flex';
    }
    
    function closeAddVaccineModal() {
      document.getElementById('addVaccineModal').style.display = 'none';
    }

    function openAddNutritionModal() {
      document.getElementById('addNutritionModal').style.display = 'flex';
    }
    
    function closeAddNutritionModal() {
      document.getElementById('addNutritionModal').style.display = 'none';
    }
    
    function openRescheduleModal(scheduleId) {
      document.getElementById('rescheduleModal').style.display = 'flex';
      document.getElementById('scheduleId').value = scheduleId;
    }
    
    function closeRescheduleModal() {
      document.getElementById('rescheduleModal').style.display = 'none';
    }

    // PDF Generation Function
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Get current date
      const currentDate = new Date().toLocaleDateString();
      
      // PDF Header
      pdf.setFontSize(20);
      pdf.setFont(undefined, 'bold');
      pdf.text('CHILD IMMUNIZATION RECORD', 105, 20, { align: 'center' });
      
      pdf.setFontSize(12);
      pdf.setFont(undefined, 'normal');
      pdf.text('Department of Health - Immunization Program', 105, 30, { align: 'center' });
      pdf.text(`Generated on: ${currentDate}`, 105, 35, { align: 'center' });
      
      // Child Information
      pdf.setFontSize(14);
      pdf.setFont(undefined, 'bold');
      pdf.text('CHILD INFORMATION', 20, 50);
      
      // Draw a line under the header
      pdf.line(20, 52, 190, 52);
      
      pdf.setFontSize(10);
      pdf.setFont(undefined, 'normal');
      
      const childName = '{{ preschooler.first_name }} {{ preschooler.last_name }}';
      const birthDate = '{{ preschooler.birth_date }}';
      const placeOfBirth = '{{ preschooler.place_of_birth|default:"" }}';
      const motherName = '{{ preschooler.parent_id.mother_name|default:"" }}';
      const fatherName = '{{ preschooler.parent_id.father_name|default:"" }}';
      const address = '{{ preschooler.address|default:"" }}';
      const birthWeight = '{{ preschooler.birth_weight|default_if_none:"" }}';
      const birthHeight = '{{ preschooler.birth_height|default_if_none:"" }}';
      const barangay = '{{ preschooler.barangay.name }}';
      const sex = '{{ preschooler.sex }}';
      
      let yPos = 60;
      
      // Child info in two columns
      pdf.text(`Child's Name: ${childName}`, 20, yPos);
      pdf.text(`Date of Birth: ${birthDate}`, 110, yPos);
      yPos += 8;
      
      pdf.text(`Place of Birth: ${placeOfBirth}`, 20, yPos);
      pdf.text(`Sex: ${sex}`, 110, yPos);
      yPos += 8;
      
      pdf.text(`Mother's Name: ${motherName}`, 20, yPos);
      pdf.text(`Father's Name: ${fatherName}`, 110, yPos);
      yPos += 8;
      
      pdf.text(`Address: ${address}`, 20, yPos);
      pdf.text(`Barangay: ${barangay}`, 110, yPos);
      yPos += 8;
      
      pdf.text(`Birth Weight: ${birthWeight} kg`, 20, yPos);
      pdf.text(`Birth Height: ${birthHeight} cm`, 110, yPos);
      yPos += 15;
      
      // Immunization Records Table
      pdf.setFontSize(14);
      pdf.setFont(undefined, 'bold');
      pdf.text('IMMUNIZATION RECORDS', 20, yPos);
      yPos += 5;
      
      // Draw table header
      pdf.setFillColor(44, 85, 48); // Dark green
      pdf.rect(20, yPos, 170, 8, 'F');
      
      pdf.setTextColor(255, 255, 255); // White text
      pdf.setFontSize(9);
      pdf.setFont(undefined, 'bold');
      pdf.text('Vaccine', 25, yPos + 5);
      pdf.text('Doses', 60, yPos + 5);
      pdf.text('Date Given', 80, yPos + 5);
      pdf.text('Status', 115, yPos + 5);
      pdf.text('Remarks', 140, yPos + 5);
      
      yPos += 8;
      pdf.setTextColor(0, 0, 0); // Black text
      pdf.setFont(undefined, 'normal');
      
      // Add immunization history
      const immunizationData = [
        {% for h in immunization_history %}
        {
          vaccine: '{{ h.vaccine_name }}',
          doses: '{{ h.required_doses }}',
          date: '{{ h.completion_date|date:"m/d/Y"|default:"" }}',
          status: 'Completed',
          remarks: '{{ h.reschedule_reason|default:"" }}'
        },
        {% endfor %}
        {% for s in pending_schedules %}
        {
          vaccine: '{{ s.vaccine_name }}',
          doses: '{{ s.required_doses }}',
          date: '{{ s.scheduled_date|date:"m/d/Y" }}',
          status: '{{ s.get_status_display }}',
          remarks: '{{ s.reschedule_reason|default:"" }}'
        },
        {% endfor %}
      ];
      
      immunizationData.forEach((record, index) => {
        // Alternate row colors
        if (index % 2 === 1) {
          pdf.setFillColor(249, 249, 249);
          pdf.rect(20, yPos, 170, 6, 'F');
        }
        
        pdf.text(record.vaccine, 25, yPos + 4);
        pdf.text(record.doses.toString(), 60, yPos + 4);
        pdf.text(record.date, 80, yPos + 4);
        pdf.text(record.status, 115, yPos + 4);
        pdf.text(record.remarks, 140, yPos + 4);
        
        yPos += 6;
        
        // Add new page if needed
        if (yPos > 270) {
          pdf.addPage();
          yPos = 20;
        }
      });
      
      // Footer
      yPos += 20;
      if (yPos > 270) {
        pdf.addPage();
        yPos = 20;
      }
      
      pdf.setFontSize(8);
      pdf.setFont(undefined, 'italic');
      pdf.text('This document is computer-generated and contains the complete immunization record.', 105, yPos, { align: 'center' });
      pdf.text('For official purposes, please verify with the issuing health center.', 105, yPos + 5, { align: 'center' });
      
      // Save the PDF
      const fileName = `${childName.replace(/\s+/g, '_')}_Immunization_Record.pdf`;
      pdf.save(fileName);
      
      // Show success message
      Swal.fire({
        title: 'PDF Generated!',
        text: 'The immunization record has been saved as a PDF file.',
        icon: 'success',
        confirmButtonColor: '#4caf50'
      });
    }
    
    // Status update functions
    function updateScheduleStatus(scheduleId, status) {
      if (status === 'completed') {
        Swal.fire({
          title: 'Mark as Completed?',
          text: 'This will deduct the vaccine from stock inventory.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#4caf50',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, complete it!'
        }).then((result) => {
          if (result.isConfirmed) {
            submitStatusUpdate(scheduleId, status);
          }
        });
      } else {
        submitStatusUpdate(scheduleId, status);
      }
    }
    
    function submitStatusUpdate(scheduleId, status) {
      console.log(`Updating schedule ${scheduleId} to status: ${status}`);
      
      fetch(`/update_schedule_status/${scheduleId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          status: status
        })
      })
      .then(response => {
        console.log('Response received:', response);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          Swal.fire('Success!', data.message, 'success').then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Error!', data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error!', 'Something went wrong.', 'error');
      });
    }
  </script>
</head>
<body>

<div class="preschooler-details">

  <div class="preschooler-header">
    <div style="position: absolute; top: 40px; right: 40px; z-index: 1000;">
      <button class="btn view-vaccine-card" onclick="location.href='/preschoolers'">
        ← Back
      </button>
    </div>

    <div class="photo-placeholder">
      {% if preschooler.profile_photo %}
        <img src="{{ preschooler.profile_photo.url }}" alt="Photo of {{ preschooler.first_name }}" class="child-photo">
      {% else %}
        <div class="default-photo-box">No Photo</div>
      {% endif %}
    </div>

    <div class="child-info-section">
      <p><strong class="child-name">{{ preschooler.first_name }} {{ preschooler.last_name }}</strong></p>
      <p class="child-age">Age: {{ age_years }} years, {{ age_months }} months, {{ age_days }} days</p>
      <p class="child-barangay">Barangay: {{ preschooler.barangay.name }}</p>
      <p class="child-gender">Gender: {{ preschooler.sex }}</p>
      <p class="child-birth">Birth Date: {{ preschooler.birth_date }}</p>
      <p class="child-weight">Weight: {% if bmi %}{{ bmi.weight }} kg{% else %}N/A{% endif %}</p>
      <p class="child-height">Height: {% if bmi %}{{ bmi.height }} cm{% else %}N/A{% endif %}</p>
      <p class="birth_height">Birth height: {{ preschooler.birth_height|default_if_none:'' }} kg</p>
      <p class="birth_weight">Birth weight: {{ preschooler.birth_weight|default_if_none:'' }} cm</p>
      <p class="time_of_birth">Time of birth: {{ preschooler.time_of_birth|default:'' }}</p>
      <p class="place_of_birth">Place of birth: {{ preschooler.place_of_birth|default:'' }} </p>
      <p class="type_of_birth">Type of Birth: {{ preschooler.type_of_birth|default:'' }}</p>
      <p class="place_of_delivery">Place of Delivery: {{ preschooler.place_of_delivery|default:'' }}</p>
    </div>

    <div class="child-info-section">
      <p class="weight-for-age">
        Weight-for-Age Standard: 
        {% if standard_weight %}{{ standard_weight }} kg{% else %}N/A{% endif %}
      </p>
      <p class="weight-for-age-status">
        Weight-for-Age Status: {{ weight_for_age_status }}
      </p>
      <p class="height-for-age">
        Height-for-Age Standard: 
        {% if standard_height %}{{ standard_height }} cm{% else %}N/A{% endif %}
      </p>
      <p class="height-for-age-status">
        Height-for-Age Status: {{ height_for_age_status }}
      </p>
      <p class="weight-height-for-age">Weight-Height-for-Age: {{ preschooler.weight_height_for_age|default:"-" }}</p>
      <p class="bmi">BMI: {% if bmi %}{{ bmi.bmi_value }}{% else %}N/A{% endif %}</p>
      <p class="immunization-status">Nutritional status: {{ nutritional_status }}</p>
      <button class="btn view-vaccine-card" onclick="openVaccineCardModal()">View Vaccine Card</button>
    </div>
  </div>

  <div class="section-header">
    <h4>Immunization Schedule</h4>
    <button class="btn add-schedule-btn" onclick="openAddScheduleModal()">+ Add Vaccination Schedule</button>
  </div>
  <table class="info-table">
    <tr>
      <th>Vaccine Name</th>
      <th>Required Dosage</th>
      <th>Immunization Date</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
    {% for s in pending_schedules %}
    <tr>
      <td>{{ s.vaccine_name }}</td>
      <td>{{ s.required_doses }}</td>
      <td>{{ s.scheduled_date|date:"m/d/Y" }}</td>
      <td>
        <span class="status-badge status-{{ s.status }}">
          {{ s.get_status_display }}
        </span>
      </td>
      <td>
        {% if s.status == 'scheduled' %}
          <div class="action-buttons">
            <button class="btn-sm btn-complete" onclick="updateScheduleStatus({{ s.id }}, 'completed')">
              Complete
            </button>
            <button class="btn-sm btn-reschedule" onclick="openRescheduleModal({{ s.id }})">
              Reschedule
            </button>
          </div>
        {% elif s.status == 'completed' %}
          <span class="text-success">✓ Completed</span>
          {% if s.completion_date %}
            <br><small>{{ s.completion_date|date:"m/d/Y H:i" }}</small>
          {% endif %}
        {% elif s.status == 'rescheduled' %}
          <div class="action-buttons">
            <button class="btn-sm btn-complete" onclick="updateScheduleStatus({{ s.id }}, 'completed')">
              Complete
            </button>
          </div>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="5">No schedule available.</td></tr>
    {% endfor %}
  </table>

  <div class="section-header">
    <h4>Immunization History</h4>
    <button class="btn add-schedule-btn" onclick="openAddVaccineModal()">+ Add Vaccine</button>
  </div>
  <table class="info-table">
    <tr>
      <th>Vaccine Name</th>
      <th>Required Doses</th>
      <th>Immunization Date</th>
      <th>Status</th>
      <th>Completion Date</th>
    </tr>
    {% for h in immunization_history %}
    <tr>
      <td>{{ h.vaccine_name }}</td>
      <td>{{ h.required_doses }}</td>
      <td>{{ h.scheduled_date|date:"m/d/Y" }}</td>
      <td>
        <span class="status-badge status-{{ h.status }}">
          {{ h.get_status_display }}
        </span>
      </td>
      <td>
        {% if h.completion_date %}
          {{ h.completion_date|date:"m/d/Y H:i" }}
        {% else %}
          -
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="5">No immunization history found.</td></tr>
    {% endfor %}
  </table>

  <div class="section-header">
    <h4>Nutrition Services</h4>
    <button class="btn add-nutrition-btn" onclick="openAddNutritionModal()">+ Add Nutrition Service</button>
  </div>
  <table class="info-table">
    <tr>
      <th>Service Type</th>
      <th>Date Completed</th>
      <th>Status</th>
    </tr>
    {% for n in nutrition_services %}
    <tr>
      <td>{{ n.service_type }}</td>
      <td>{{ n.completion_date|date:"m/d/Y H:i" }}</td>
      <td>
        <span class="status-badge status-completed">
          Completed
        </span>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="3">No nutrition services recorded.</td></tr>
    {% endfor %}
  </table>

  <h4>Nutritional Status History</h4>
  <table class="info-table">
    <tr>
      <th>Date Measured</th>
      <th>Temperature</th>
      <th>Height (cm)</th>
      <th>Weight (kg)</th>
      <th>BMI</th>
      <th>BMI Category</th>
      <th>Standard Weight (kg)</th>
      <th>Standard Height (cm)</th>
      <th>Weight Status</th>
      <th>Height Status</th>
    </tr>
    {% for record in preschooler.bmi_set.all %}
    <tr>
      <td>{{ record.date_measured|date:"m/Y" }}</td>
      <td>{{ record.temperature }}</td>
      <td>{{ record.height_cm }}</td>
      <td>{{ record.weight_kg }}</td>
      <td>{{ record.bmi }}</td>
      <td>{{ record.bmi_category }}</td>
      <td>{{ standard_weight|default:"N/A" }}</td>
      <td>{{ standard_height|default:"N/A" }}</td>
      <td>{{ weight_for_age_status }}</td>
      <td>{{ height_for_age_status }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="10">No records found.</td></tr>
    {% endfor %}
  </table>

</div>

<!-- Vaccine Card Modal -->
<div id="vaccineCardModal" class="modal-overlay">
  <div class="modal-card">
    <button class="close-modal" onclick="closeVaccineCardModal()">×</button>
    <h2 style="text-align: center; margin-bottom: 30px; font-size: 28px; font-weight: bold;">Child Immunization Record</h2>

    <!-- FORM to UPDATE child & parent info -->
    <form method="POST" action="{% url 'update_child_info' preschooler.preschooler_id %}">
      {% csrf_token %}
      <div class="modal-info-grid">

        <div>
          <label>Child's name:</label>
          <input type="text" value="{{ preschooler.first_name }} {{ preschooler.last_name }}" readonly>
        </div>

        <div>
          <label>Date of birth:</label>
          <input type="text" value="{{ preschooler.birth_date }}" readonly>
        </div>

        <div>
          <label>Place of birth:</label>
          <input type="text" name="place_of_birth" value="{{ preschooler.place_of_birth|default:'' }}">
        </div>

        <div>
          <label>Mother's name:</label>
          <input type="text" name="mother_name" value="{{ preschooler.parent_id.mother_name|default:'' }}">
        </div>

        <div>
          <label>Father's name:</label>
          <input type="text" name="father_name" value="{{ preschooler.parent_id.father_name|default:'' }}">
        </div>

        <div>
          <label>Address:</label>
          <input type="text" name="address" value="{{ preschooler.address|default:'' }}">
        </div>

        <div>
          <label>Birth weight (kg):</label>
          <input type="number" name="birth_weight" step="0.01" value="{{ preschooler.birth_weight|default_if_none:'' }}">
        </div>

        <div>
          <label>Birth height (cm):</label>
          <input type="number" name="birth_height" step="0.01" value="{{ preschooler.birth_height|default_if_none:'' }}">
        </div>

        <div>
          <label>Health Center:</label>
          <input type="text" name="health_center" value="{{ preschooler.health_center|default:'' }}">
        </div>

        <div>
          <label>Barangay:</label>
          <input type="text" value="{{ preschooler.barangay.name }}" readonly>
        </div>

        <div>
          <label>Sex:</label>
          <div style="display: flex; gap: 20px; margin-top: 8px;">
            <label style="display: flex; align-items: center; font-weight: normal;">
              <input type="radio" name="sex" value="Male" {% if preschooler.sex == 'Male' %}checked{% endif %} disabled style="margin-right: 8px;"> Male
            </label>
            <label style="display: flex; align-items: center; font-weight: normal;">
              <input type="radio" name="sex" value="Female" {% if preschooler.sex == 'Female' %}checked{% endif %} disabled style="margin-right: 8px;"> Female
            </label>
          </div>
        </div>

      </div>

      <div class="modal-action-buttons">
        <button type="button" class="btn btn-orange" onclick="generatePDF()">📄 Save as PDF</button>
        <button type="submit" class="btn btn-green">Save Changes</button>
      </div>

      <!-- Immunization History Table in Modal -->
      <table class="vaccine-table">
        <thead>
          <tr>
            <th style="width: 25%;">Vaccine</th>
            <th style="width: 15%;">Doses</th>
            <th style="width: 15%;">Date of Vaccination<br><small style="font-weight: normal;">MM/DD/YY</small></th>
            <th style="width: 20%;">Status</th>
            <th style="width: 35%;">Remarks</th>
          </tr>
        </thead>
        <tbody>
          {% for h in immunization_history %}
          <tr>
            <td class="vaccine-name">{{ h.vaccine_name }}</td>
            <td><span class="dose-badge">{{ h.required_doses }}</span> / {{ h.required_doses }}</td>
            <td><input type="date" name="vaccine_date_{{ h.id }}" value="{{ h.completion_date|date:'Y-m-d' }}" readonly style="pointer-events: none; background: transparent; border: none;"></td>
            <td><input type="text" name="vaccine_status_{{ h.id }}" value="{% if h.status == 'completed' %}Completed{% else %}{{ h.reschedule_reason|default:'' }}{% endif %}" readonly style="pointer-events: none; background: transparent; border: none;"></td>
            <td><input type="text" name="vaccine_remarks_{{ h.id }}" value="{{ h.reschedule_reason|default:'' }}" readonly></td>
          </tr>
          {% empty %}
          
          {% endfor %}
          
          {% for s in pending_schedules %}
          <tr>
            <td class="vaccine-name">{{ s.vaccine_name }}</td>
            <td><span class="dose-badge">{{ s.required_doses }}</span></td>
            <td><input type="date" name="schedule_date_{{ s.id }}" value="{{ s.scheduled_date|date:'Y-m-d' }}" readonly style="pointer-events: none; background: transparent; border: none;"></td>
            <td><input type="text" name="schedule_status_{{ s.id }}" value="{% if s.status == 'completed' %}Completed{% else %}{{ s.reschedule_reason|default:'Scheduled' }}{% endif %}" readonly style="pointer-events: none; background: transparent; border: none;"></td>
            <td><input type="text" name="schedule_remarks_{{ s.id }}" value="{{ s.reschedule_reason|default:'' }}" readonly></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <p class="modal-note">
        In the column,<strong>Date of Vaccination</strong>, write the date of vaccination according to how many doses has already been administered.<br>
        In the column, <strong>Status</strong>, write the date for the next dose, or any important information that may affect the child's vaccination.
      </p>
    </form>
  </div>
</div>

<!-- Add Schedule Modal -->
<div id="addScheduleModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeAddScheduleModal()">×</button>
    <h3>Add Vaccination Schedule</h3>
    <form id="addScheduleForm" method="post" action="{% url 'add_schedule' preschooler.preschooler_id %}">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="vaccineName">Vaccine Name:</label>
        <select id="vaccineName" name="vaccine_name" required>
          <option value="">Select Vaccine</option>
          {% for vaccine in available_vaccines %}
            <option value="{{ vaccine.vaccine_name }}">
              {{ vaccine.vaccine_name }} (Available: {{ vaccine.available_stock }})
            </option>
          {% empty %}
            <option value="" disabled>No vaccines available in stock</option>
          {% endfor %}
        </select>
      </div>

      <!-- Hidden field for doses - defaults to 1 -->
      <input type="hidden" name="vaccine_doses" value="1">
      
      <div class="form-group">
        <label for="requiredDoses">Required Doses:</label>
        <input type="number" id="requiredDoses" name="required_doses" min="1" required>
      </div>

      <div class="form-group">
        <label for="immunizationDate">Immunization Date:</label>
        <input type="date" id="immunizationDate" name="immunization_date" required>
      </div>
      
      <!-- Hidden field for next vaccine schedule - empty by default -->
      <input type="hidden" name="next_vaccine_schedule" value="">

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Save</button>
        <button type="button" class="btn btn-gray" onclick="closeAddScheduleModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Nutrition Service Modal -->
<div id="addNutritionModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeAddNutritionModal()">×</button>
    <h3>Add Completed Nutrition Service</h3>
    <form id="addNutritionForm" method="post" action="{% url 'add_nutrition_service' preschooler.preschooler_id %}">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="serviceType">Service Type:</label>
        <select id="serviceType" name="service_type" required>
          <option value="">Select Service</option>
          {% for medicine in available_medicines %}
            <option value="{{ medicine.vaccine_name }}">
              {{ medicine.vaccine_name }} (Available: {{ medicine.available_stock }})
            </option>
          {% empty %}
            <option value="" disabled>No nutrition services available in stock</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="completionDate">Date Completed:</label>
        <input type="datetime-local" id="completionDate" name="completion_date" required>
      </div>

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Save</button>
        <button type="button" class="btn btn-gray" onclick="closeAddNutritionModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Vaccine Modal (for completed vaccines) -->
<div id="addVaccineModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeAddVaccineModal()">×</button>
    <h3>Add Completed Vaccine</h3>
    <form id="addVaccineForm" method="post" action="{% url 'add_vaccine' preschooler.preschooler_id %}">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="vaccineNameCompleted">Vaccine Name:</label>
        <select id="vaccineNameCompleted" name="vaccine_name" required>
          <option value="">Select Vaccine</option>
          {% for vaccine in available_vaccines %}
            <option value="{{ vaccine.vaccine_name }}">
              {{ vaccine.vaccine_name }} (Available: {{ vaccine.available_stock }})
            </option>
          {% empty %}
            <option value="" disabled>No vaccines available in stock</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="requiredDosesCompleted">Required Doses:</label>
        <input type="number" id="requiredDosesCompleted" name="required_doses" min="1" required>
      </div>

      <div class="form-group">
        <label for="immunizationDateCompleted">Immunization Date:</label>
        <input type="date" id="immunizationDateCompleted" name="immunization_date" required>
      </div>

      <div class="form-group">
        <label for="completionDateCompleted">Completion Date:</label>
        <input type="datetime-local" id="completionDateCompleted" name="completion_date" required>
      </div>

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Save</button>
        <button type="button" class="btn btn-gray" onclick="closeAddVaccineModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Reschedule Modal -->
<div id="rescheduleModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeRescheduleModal()">×</button>
    <h3>Reschedule Vaccination</h3>
    <form id="rescheduleForm" method="post" action="{% url 'reschedule_vaccination' %}">
      {% csrf_token %}
      <input type="hidden" id="scheduleId" name="schedule_id">
      
      <div class="form-group">
        <label for="newDate">New Date:</label>
        <input type="date" id="newDate" name="new_date" required>
      </div>

      <div class="form-group">
        <label for="rescheduleReason">Reason for Rescheduling:</label>
        <textarea id="rescheduleReason" name="reschedule_reason" rows="3" required></textarea>
      </div>

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Reschedule</button>
        <button type="button" class="btn btn-gray" onclick="closeRescheduleModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

</body>
</html>